<div class="bg-white border-[3px] border-[#B5A89A] rounded-lg shadow-[0_15px_40px_rgba(54,84,66,0.08)] p-8 md:p-12">

  <h2 class="text-2xl font-serif font-bold text-[#365442] mb-10 text-center border-b-2 border-[#F1EFE9] pb-6">
    Registration Form / 登録フォーム
  </h2>

  <%= form_with model: tea_product, local: true do |f| %>

    <% if tea_product.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-8 font-serif text-sm">
        <p class="font-bold mb-1">入力内容に不備があります：</p>
        <ul class="list-disc list-inside opacity-90 font-semibold">
          <% tea_product.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-12 border-b-2 border-[#F1EFE9] pb-8">
      <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-4">
        Visual Record / 画像
      </label>
      
      <% if tea_product.persisted? && tea_product.image.attached? %>
        <div class="mb-4">
          <%= image_tag tea_product.image,
                class: "w-40 h-40 object-cover rounded border-2 border-[#D6CEC5] shadow-sm" %>
        </div>
      <% end %>

      <%= f.file_field :image,
            accept: "image/*",
            class: "block w-full text-sm font-bold text-[#8C7B6C]
                   file:mr-4 file:py-2 file:px-4
                   file:rounded file:border-2 file:border-[#365442]
                   file:text-xs file:font-bold file:tracking-widest
                   file:bg-[#365442] file:text-white
                   hover:file:bg-[#2A4034] cursor-pointer" %>
    </div>

    <div class="mb-10">
      <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">
        Tea Name / 紅茶名
      </label>
      <%= f.text_field :name,
            autocomplete: "off",
            class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded
                   focus:ring-2 focus:ring-[#365442] focus:border-[#365442] outline-none transition font-semibold text-lg text-[#26302A]" %>
    </div>

    <div class="mb-10" data-controller="brand-suggest" data-brand-suggest-url-value="/brands/search">
      <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">
        Manufacturer & Brand / ブランド
      </label>
      <input
        type="text"
        name="tea_product[brand_name]"
        value="<%= tea_product.brand&.display_name || tea_product.brand_name %>"
        data-brand-suggest-target="input"
        data-action="input->brand-suggest#search keyup->brand-suggest#search"
        placeholder="ブランド名を入力..."
        class="w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded
               focus:ring-2 focus:ring-[#365442] focus:border-[#365442] outline-none transition font-semibold text-[#26302A]"
        autocomplete="off"
      >
      <input type="hidden" name="tea_product[brand_id]" value="<%= tea_product.brand_id %>" data-brand-suggest-target="hidden">
      <ul data-brand-suggest-target="list" class="bg-white border-2 border-[#D6CEC5] border-t-0 mt-0 max-h-40 overflow-y-auto rounded-b shadow-lg z-10 font-semibold text-[#26302A]"></ul>
    </div>

    <div class="grid md:grid-cols-2 gap-8 mb-10">
      <div>
        <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">
          Classification / 茶葉タイプ
        </label>
        <%= f.select :tea_type,
              TeaProduct.tea_types.keys.map { |k| [TeaProduct.new(tea_type: k).enum_i18n(:tea_type), k] },
              { include_blank: "選択してください" },
              class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded focus:ring-2 focus:ring-[#365442] outline-none font-semibold text-[#26302A]" %>
      </div>

      <div>
        <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">
          Caffeine / カフェイン
        </label>
        <%= f.select :caffeine_level,
              TeaProduct.caffeine_levels.keys.map { |k| [TeaProduct.new(caffeine_level: k).enum_i18n(:caffeine_level), k] },
              { include_blank: "選択してください" },
              class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded focus:ring-2 focus:ring-[#365442] outline-none font-semibold text-[#26302A]" %>
      </div>
    </div>

    <div class="mb-10 bg-[#F9F7F2] p-6 rounded border-2 border-[#D6CEC5]"
         data-controller="flavor-select"
         data-flavor-select-url-value="/flavor_categories"
         data-flavor-select-selected-ids-value="<%= @tea_product.flavor_ids.join(',') %>">
  
      <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-4">
        Flavor Selection / フレーバー設定
      </label>

      <div class="space-y-6">
        <div>
          <p class="text-xs text-[#365442] mb-2 font-bold uppercase tracking-widest">1. Categories (Multiple) / 大カテゴリ選択</p>
          <div class="flex flex-wrap gap-4 p-3 bg-white border-2 border-[#D6CEC5] rounded">
            <% FlavorCategory.order(:created_at).each do |category| %>
              <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" 
                       value="<%= category.id %>" 
                       name="tea_product[selected_flavor_category_ids][]"
                       data-action="change->flavor-select#toggleCategory"
                       class="rounded text-[#365442] focus:ring-[#365442]"
                       <%= "checked" if @selected_flavor_category_ids&.include?(category.id.to_s) || @tea_product.flavors.any? { |f| f.flavor_category_id == category.id } %>>
                <span class="text-sm font-semibold text-[#26302A]"><%= category.name %></span>
              </label>
            <% end %>
          </div>
        </div>

        <div>
          <p class="text-xs text-[#365442] mb-2 font-bold uppercase tracking-widest">2. Detailed Notes / フレーバー詳細</p>
          <input type="hidden" name="tea_product[flavor_ids][]" value="">
          <%# 各カテゴリごとのフレーバーリストがここに追加される %>
          <div data-flavor-select-target="list" class="space-y-4 font-semibold text-[#26302A]">
          </div>
        </div>
      </div>
    </div>

    <div class="mb-12 border-t-2 border-[#F1EFE9] pt-10">
      <h3 class="text-sm font-bold text-[#365442] tracking-[0.3em] uppercase mb-6 flex items-center gap-2">
        <span class="w-2.5 h-2.5 rounded-full bg-[#A75F29]"></span>
        Provenance / 購入場所
      </h3>

      <% purchase_location = @tea_product.purchase_locations.first %>
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">Location Type</label>
          <%= select_tag "tea_product[purchase_location][location_type]",
                options_for_select(PurchaseLocation.location_types.keys.map { |k| [PurchaseLocation.new(location_type: k).enum_i18n(:location_type), k] }, purchase_location&.location_type),
                prompt: "種類を選択",
                class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded font-semibold text-[#26302A]" %>
        </div>
        <div>
          <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">Store Name</label>
          <%= text_field_tag "tea_product[purchase_location][name]",
                purchase_location&.name,
                placeholder: "例：LUPICIA 自由が丘本店",
                autocomplete: "off",
                class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded font-semibold text-[#26302A]" %>
        </div>
      </div>
    </div>

    <div class="mb-12">
      <label class="block text-xs font-bold text-[#365442] tracking-[0.2em] uppercase mb-2">
        Curator's Notes / 説明・レビュー
      </label>
      <%= f.text_area :description,
            rows: 6,
            placeholder: "この紅茶の個性や、淹れた時の香りの変化などを記してください...",
            class: "w-full p-4 bg-[#FDFBF9] border-2 border-[#D6CEC5] rounded
                   focus:ring-2 focus:ring-[#365442] outline-none font-semibold leading-loose text-[#26302A]" %>
    </div>

    <div class="text-center pt-6">
      <%= f.submit "変更を保存する",
            class: "bg-[#365442] hover:bg-[#2A4034] text-[#F9F7F2] px-12 py-4
                   rounded shadow-lg font-bold tracking-[0.2em] transition duration-300 cursor-pointer text-lg" %>
      
      <p class="mt-4 text-xs text-[#8C7B6C] font-bold italic tracking-widest">
        * 申請前に必ず内容を保存してください
      </p>
    </div>

  <% end %>

</div>